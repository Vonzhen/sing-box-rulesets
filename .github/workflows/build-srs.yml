name: Build sing-box rule-set

# 手动触发、定时和 master 推送触发
on:
  workflow_dispatch:
  schedule:
    - cron: "30 22 * * *" # 每天 6:30 AM UTC+8
  push:
    branches:
      - master
    paths-ignore:
      - "**/README.md"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout 自己仓库
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Checkout 官方转换工具
      - name: Checkout meta-rules-converter
        uses: actions/checkout@v4
        with:
          repository: MetaCubeX/meta-rules-converter
          path: convert

      # 3. 安装 Go
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      # 4. 检查 JSON 是否有变化
      - name: Check JSON changes
        id: check_json
        run: |
          mkdir -p sing-rule
          CHANGED=0
          for file in rules-src/*.json; do
            name=$(basename "$file" .json)
            OUTFILE="sing-rule/$name.srs"
            if [ ! -f "$OUTFILE" ] || ! cmp -s "$file" "$OUTFILE"; then
              echo "JSON changed: $file"
              CHANGED=1
            fi
          done
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT

      # 5. 编译 srs 文件（只有 JSON 有变化才执行）
      - name: Compile JSON to srs
        if: steps.check_json.outputs.changed == '1'
        run: |
          mkdir -p sing-rule
          cd convert
          for file in ../rules-src/*.json; do
            name=$(basename "$file" .json)
            echo "Converting $file → sing-rule/$name.srs"
            go run ./ geosite -f "$file" -o "../sing-rule/$name" -t sing-box
          done
          cd ..

      # 6. 提交并推送 sing-rule 分支
      - name: Commit sing-rule
        if: steps.check_json.outputs.changed == '1'
        run: |
          cd sing-rule
          git init
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -b sing
          git add .
          git commit -m "Update rule-set on $(date +'%Y-%m-%d %H:%M')"
          git remote add origin "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
          git push -f -u origin sing
