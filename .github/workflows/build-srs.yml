name: Build Sing-Box Rules
on:
  workflow_dispatch:
  schedule:
    - cron: "30 22 * * *"  # 每天 6:30 AM UTC+8
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest
    steps:

      # 1️⃣ Checkout 仓库
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2️⃣ 安装 sing-box v1.11.4
      - name: Setup sing-box v1.11.4
        run: |
          wget https://github.com/SagerNet/sing-box/releases/download/v1.11.4/sing-box-1.11.4-linux-amd64.tar.gz
          tar zxvf sing-box-1.11.4-linux-amd64.tar.gz
          mv sing-box-1.11.4-linux-amd64/sing-box ./
          chmod +x sing-box

      # 3️⃣ 安装 Go（供官方 converter 使用）
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      # 4️⃣ Compile JSON → srs（兼容 1.11.4）
      - name: Compile JSON rules to srs
        run: |
          mkdir -p sing-rule
          for file in rules-src/*.json; do
            name=$(basename "$file" .json)
            echo "Compiling $file → sing-rule/$name.srs"
            ./sing-box rule-set compile --output "sing-rule/$name.srs" "$file"
          done

      # 5️⃣ 下载 geosite/geoip 数据并生成 meta-rule
      - name: Download geo data
        run: |
          wget -O geoip.dat https://github.com/Loyalsoldier/geoip/raw/release/geoip.dat
          wget -O geosite.dat https://github.com/Loyalsoldier/geoip/raw/release/geosite.dat

      - name: Convert geo to meta-rule-set
        run: |
          mkdir -p meta-rule/geo/geosite meta-rule/geo/geoip
          git clone https://github.com/MetaCubeX/meta-rules-converter convert
          cd convert
          go run ./ geosite -f ../geosite.dat -o ../meta-rule/geo/geosite
          go run ./ geoip -f ../geoip.dat -o ../meta-rule/geo/geoip

      # 6️⃣ 推送 sing-rule / meta-rule 分支
      - name: Push sing-rule branch
        run: |
          cd sing-rule
          git init
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -b sing
          git add .
          git commit -m "Update sing-rule srs files"
          git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
          git push -f -u origin sing

      - name: Push meta-rule branch
        run: |
          cd meta-rule
          git init
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -b meta
          git add .
          git commit -m "Update meta-rule files"
          git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
          git push -f -u origin meta

      # 7️⃣ 创建 Release
      - name: Create Release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          release_name: Release $(date +"%Y-%m-%d %H:%M")
          tag: latest
          file_glob: true
          overwrite: true
          file: ./sing-rule/* ./meta-rule/*
