name: Build sing-box rule-set (.srs)

on:
  push:
    paths:
      - "rules-src/**/*.json"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install sing-box
        run: |
          SB_VER=1.12.1
          curl -L -o sing-box.tar.gz \
            https://github.com/SagerNet/sing-box/releases/download/v${SB_VER}/sing-box-${SB_VER}-linux-amd64.tar.gz
          tar -xzf sing-box.tar.gz
          chmod +x sing-box-${SB_VER}-linux-amd64/sing-box
          mv sing-box-${SB_VER}-linux-amd64/sing-box ./sing-box

      # ✅ 调试版本输出
      - name: Check sing-box version
        run: |
          ./sing-box version
          ls -l ./sing-box

      - name: Compile json → srs
        run: |
          mkdir -p rules
          for file in rules-src/*.json; do
            name=$(basename "$file" .json)
            echo "Compiling $file → rules/$name.srs"
            ./sing-box rule-set compile "$file" -o "rules/$name.srs"
          done

          echo "Files in rules directory:"
          ls -l rules/

      - name: Commit srs if changed
        run: |
          echo "Files in rules before commit:"
          ls -l rules/
          if git diff --quiet rules; then
            echo "No srs changes, skip commit"
          else
            git config user.name "github-actions"
            git config user.email "github-actions@github.com"
            git add rules/*.srs
            git commit -m "build: update rule-set srs"
            git push
          fi
